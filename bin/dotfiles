#!/bin/bash

DOTFILES=`dirname "$0"`
cd "$DOTFILES/../dotfiles"
BASE=`pwd`
CURRENT_FOLDER=`cd -`

trim() {
  echo $1
}

genlinks() {
  for FILE in `ls -A $BASE`
  do
    FILEPATH=$BASE/$FILE
    DEST=$HOME/$FILE
    OLD=$HOME/old.dotfiles
    if [ -a  "$DEST" ]
    then
      if [ ! -d $OLD ]
      then
        mkdir -p $OLD
      fi
      DEST_REAL=$DEST
      if [ -h "$DEST" ]
      then
        DEST_REAL=`readlink $DEST`
      fi
      mv $DEST_REAL $OLD
    fi
    ln -s $FILEPATH $DEST
  done
}

case "$1" in

  "add")
    ALL_FILES="${@:2:${#}}"
    for FILES in `echo $ALL_FILES`
    do
      for FILE in `echo "$FILES"`
      do
        if [ $FILE != "." ] && [ $FILE != ".." ]
        then
          cd $CURRENT_FOLDER
          FILENAME=`basename $FILE`
          if [ -h "$FILE" ]
          then
            FILE=`readlink $FILE`
          fi
          if [ `basename "$FILE"` == "$FILENAME" ]
          then
            mv `trim $FILE` `trim $BASE`
          else
            mv `trim $FILE` `trim $BASE/$FILENAME`
          fi
          ln -s `trim $BASE/$FILENAME` `trim $HOME/$FILENAME`
          cd $BASE
          git add $FILENAME
          cd ..
          git commit -m "adding $FILENAME"
        fi
      done
    done
    git push origin master
  ;;

  "select")
    #WIP
    exit 1
    FOLDER=$2
    # [ $ans == "y" ] && return 0 || return 1
    if [ ! -d "$FOLDER" ]
    then
      echo "! Not a folder"
      exit 1
    fi
    for FILE in `ls -R`
    do
      if [ -f "$FILE" ]
      then
        read -p "Include $FILE? (y/n)" Y_OR_N
        if [ "$Y_OR_N" == "y" ]
        then
          echo 1
        fi
      fi
    done
  ;;

  "save")
    cd $BASE
    git commit -am "saving `date`"
    git push origin master
  ;;

  "update")
    cd $DOTFILES
    git pull
    # add sim link to new files, check existent files to see if they are already there (if same, keep, otherwise move to old)
  ;;

  "upgrade")
    cd $DOTFILES
    git fetch dotfiles
    git merge dotfiles/master
  ;;

  "genlinks")
    genlinks
  ;;

  *)
    echo "! Unknown command"
  ;;

esac

